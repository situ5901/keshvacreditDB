const express = require("express");
const uploadRouter = express.Router();
const multer = require("multer");
const axios = require("axios");
const FormData = require("form-data");

const storage = multer.memoryStorage();
const upload = multer({ storage });

const BASE_URL = "https://api.faircent.com";
const APP_ID = "1cfa78742af22b054a57fac6cf830699";
const APP_NAME = "KESHVACREDIT";
const UPLOAD_ENDPOINT = "/v1/api/uploadprocess";
const TARGET_URL = BASE_URL + UPLOAD_ENDPOINT; // Target URL ‡§ï‡•ã ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç

// ****************************** CONSOLE LOG ADDED ******************************

uploadRouter.post(
  "/faircent/upload",
  upload.single("docImage"),
  async (req, res) => {
    console.log("=================================================");
    console.log("üöÄ [STEP 1] Faircent Upload Request Received.");

    // --- Step 1: Multer Check ---
    if (!req.file || !req.body.loan_id || !req.body.type) {
      console.log("‚ùå [ERROR] Missing Data Check Failed.");
      console.log(
        `File: ${!!req.file}, loan_id: ${req.body.loan_id}, type: ${req.body.type}`,
      );
      return res
        .status(400)
        .json({ error: "Missing file, loan_id, or type in request." });
    }

    // --- Step 2: Data Extraction ---
    console.log("‚úÖ [STEP 2] Multer executed successfully. Data Extracted:");
    console.log(`  - Loan ID: ${req.body.loan_id}`);
    console.log(`  - Document Type: ${req.body.type}`);
    console.log(`  - File Name: ${req.file.originalname}`);
    console.log(`  - File Size: ${req.file.size} bytes`); // 3. Faircent ‡§ï‡•ã ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§Ø‡§æ FormData ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Å

    const form = new FormData();
    form.append("type", req.body.type);
    form.append("loan_id", req.body.loan_id);

    // req.file.buffer ‡§∏‡•á ‡§´‡§æ‡§á‡§≤ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
    form.append("docImage", req.file.buffer, {
      filename: req.file.originalname,
      contentType: req.file.mimetype,
    });

    console.log("üõ†Ô∏è [STEP 3] FormData Object Created for Faircent.");
    console.log(`  - Target URL: ${TARGET_URL}`);

    // Access Token Placeholder (‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä)
    const ACCESS_TOKEN = "your_valid_access_token_here"; // <--- ‡§á‡§∏‡•á ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    // 4. Faircent API ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç

    try {
      const headers = {
        "x-application-id": APP_ID,
        "x-application-name": APP_NAME,
        "x-access-token": ACCESS_TOKEN, // Access Token ‡§Ø‡§π‡§æ‡§Å ‡§≠‡•á‡§ú‡•á‡§Ç
        ...form.getHeaders(),
      };

      console.log("üîç [STEP 4] Sending Request to Faircent with Headers:");
      console.log(headers);

      const faircentResponse = await axios.post(TARGET_URL, form, { headers });

      // --- Step 5: Success Response ---
      console.log("‚úÖ [STEP 5] Successfully Received Response from Faircent.");
      console.log(`  - HTTP Status: ${faircentResponse.status}`);
      console.log("  - Response Data:", faircentResponse.data); // 6. Faircent ‡§ï‡§æ ‡§ú‡§µ‡§æ‡§¨ ‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§ï‡•ã ‡§µ‡§æ‡§™‡§∏ ‡§≠‡•á‡§ú‡•á‡§Ç

      return res.status(faircentResponse.status).json(faircentResponse.data);
    } catch (error) {
      // --- Step 7: Error Handling ---
      console.error(
        "‚ùå [ERROR] An error occurred during Faircent communication:",
      );

      if (error.response) {
        // Faircent ‡§∏‡•á HTTP Error Response ‡§Æ‡§ø‡§≤‡§æ
        console.error(`  - HTTP Status: ${error.response.status}`);
        console.error("  - Faircent Error Data:", error.response.data);
        return res.status(error.response.status).json(error.response.data);
      } else if (error.request) {
        // Faircent ‡§∏‡•á ‡§ï‡•ã‡§à Response ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ (‡§ú‡•à‡§∏‡•á Timeout ‡§Ø‡§æ DNS Error)
        console.error(
          "  - No response received from Faircent (Request issue).",
        );
        console.error("  - Request details:", error.request);
      } else {
        // Local Error (‡§ú‡•à‡§∏‡•á ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§®, ‡§ü‡•ã‡§ï‡§®, ‡§Ü‡§¶‡§ø)
        console.error("  - Local error or Axios setup issue.");
        console.error("  - Message:", error.message);
      }

      return res.status(500).json({
        success: false,
        message: "Internal server error while forwarding file.",
        detail: error.message,
      });
    } finally {
      console.log("=================================================\n");
    }
  },
);

module.exports = uploadRouter;
